{% extends 'base.html' %}

{% block meta %}
<title>Register - Ball-Ballan</title>
{% endblock meta %}

{% block content %}
<div class="form-style">
    <div class="min-h-screen bg-gray-50 flex items-center justify-center p-8">
        <div class="max-w-md w-full relative z-10">
            <div class="bg-white border border-gray-200 rounded-lg p-8 shadow-sm">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold text-gray-900 mb-2">Join Us</h2>
                    <p class="text-gray-500">Create your Ball-Ballan account</p>
                </div>

                <!-- Form Errors Display -->
                <div id="form-errors"></div>

                <form id="register-form" method="POST" action="{% url 'main:register' %}" class="space-y-5">
                    {% csrf_token %}

                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                            Username
                        </label>
                        <input id="username" name="username" type="text" required
                            class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200"
                            placeholder="Username">
                    </div>

                    <div>
                        <label for="password1" class="block text-sm font-medium text-gray-700 mb-2">
                            Password
                        </label>
                        <input id="password1" name="password1" type="password" required
                            class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200"
                            placeholder="Password">
                    </div>

                    <div>
                        <label for="password2" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input id="password2" name="password2" type="password" required
                            class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-green-500 transition duration-200"
                            placeholder="Confirm your password">
                    </div>

                    <button id="register-button" type="submit"
                        class="w-full text-white font-medium py-3 px-4 rounded-md transition-colors
                        bg-[#0043ae] hover:bg-[#003080] flex justify-center items-center">
                        <span id="button-text">
                            Create Account
                        </span>
                        <svg id="button-spinner" class="hidden ml-2 w-5 h-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.5-3.5L12 0v4a8 8 0 00-8 8h4z"></path>
                        </svg>
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <p class="text-gray-500 text-sm">
                        Already have an account?
                        <a href="{% url 'main:login' %}" class="text-[#0043ae] hover:text-[#003080] font-medium">
                            Sign In
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("register-form");
    const button = document.getElementById("register-button");
    const buttonText = document.getElementById("button-text");
    const buttonSpinner = document.getElementById("button-spinner");
    const errorContainer = document.getElementById("form-errors");
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    form.addEventListener("submit", (e) => {
        e.preventDefault();

        // Clear previous errors
        errorContainer.innerHTML = "";

        const formData = new FormData(form);

        button.disabled = true;
        buttonText.textContent = "Processing...";
        buttonSpinner.classList.remove("hidden");

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" },
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Registration successful! Your account has been created.");
                window.location.href = "{% url 'main:login' %}";
            } else {
                let messages = [];
                if (data.errors) {
                    Object.values(data.errors).forEach(arr => arr.forEach(msg => messages.push(msg)));
                } else if (data.error) {
                    messages.push(data.error);
                } else {
                    messages.push("Please check your form entries.");
                }

                messages.forEach(msg => alert("Registration Failed: " + msg));
            }
        })
        .catch(() => showToast("Something went wrong", "Server is not responding.", "error"))
        .finally(() => {
            button.disabled = false;
            buttonText.textContent = "Create Account";
            buttonSpinner.classList.add("hidden");
        });
    });
});
</script>
{% endblock content %}
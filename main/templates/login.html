{% extends 'base.html' %}

{% block meta %}
<title>Login - Ball-Ballan</title>
{% endblock meta %}

{% block content %}
<div class="bg-gray-50 w-full min-h-screen flex items-center justify-center p-8">
    <div class="max-w-md w-full">
        <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8 form-style">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">Sign In</h1>
                <p class="text-gray-600">Welcome back to Ball-Ballan</p>
            </div>

            <!-- Form Errors Display -->
            <div id="form-errors"></div>

            <form id="login-form" method="POST" action="{% url 'main:login' %}" class="space-y-6">
                {% csrf_token %}

                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input id="username" name="username" type="text" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-green-500 transition-colors"
                        placeholder="Username">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input id="password" name="password" type="password" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-green-500 transition-colors"
                        placeholder="Password">
                </div>

                <button id="login-btn" type="submit" class="w-full text-white font-medium py-3 px-4 rounded-md transition-colors
                            bg-[#0043ae] hover:bg-[#003080] flex justify-center items-center">
                    <span id="button-text">Sign In</span>
                    <svg id="button-spinner" class="hidden ml-2 w-5 h-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3.5-3.5L12 0v4a8 8 0 00-8 8h4z"></path>
                    </svg>
                </button>
            </form>

            <!-- Messages Display -->
            {% if messages %}
            <div class="mt-6">
                {% for message in messages %}
                <div class="px-4 py-3 rounded-md text-sm border
                    {% if message.tags == 'success' %}
                      bg-green-50 border-green-200 text-green-700
                    {% elif message.tags == 'error' %}
                      bg-red-50 border-red-200 text-red-700
                    {% else %}
                      bg-gray-50 border-gray-200 text-gray-700
                    {% endif %}
                ">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="mt-6 text-center pt-6 border-t border-gray-200">
                <p class="text-gray-500 text-sm">
                    Don't have an account?
                    <a href="{% url 'main:register' %}" class="text-[#0043ae] hover:text-[#003080] font-medium">
                        Register Now
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("login-form");
    const btn = document.getElementById("login-btn");
    const buttonText = document.getElementById("button-text");
    const buttonSpinner = document.getElementById("button-spinner");
    const errorContainer = document.getElementById("form-errors");

    form.addEventListener("submit", (e) => {
        e.preventDefault();
        errorContainer.innerHTML = "";

        const formData = new FormData(form);
        const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

        btn.disabled = true;
        buttonText.textContent = "Processing...";
        buttonSpinner.classList.remove("hidden");

        fetch(form.action, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("You have successfully logged in. Welcome back!");
                setTimeout(() => window.location.href = "{% url 'main:show_main' %}", 1000);
            } else {
                const msg = data.error || "Username or password is incorrect.";
                const div = document.createElement("div");
                div.className = "px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2";
                div.textContent = msg;
                errorContainer.appendChild(div);
            }
        })
        .catch(() => {
            const div = document.createElement("div");
            div.className = "px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700 mb-2";
            div.textContent = "Terjadi kesalahan. Server tidak merespons.";
            errorContainer.appendChild(div);
        })
        .finally(() => {
            btn.disabled = false;
            buttonText.textContent = "Sign In";
            buttonSpinner.classList.add("hidden");
        });
    });
});
</script>
{% endblock content %}